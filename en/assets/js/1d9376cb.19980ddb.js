"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([["6104"],{4858:function(e,n,r){r.r(n),r.d(n,{metadata:()=>t,contentTitle:()=>l,default:()=>d,assets:()=>a,toc:()=>u,frontMatter:()=>o});var t=JSON.parse('{"id":"iaas/quickstart_iaas","title":"Automatisation avec Terraform","description":"Ce guide va vous permettre de d\xe9ployer en moins de 5 minutes vos premi\xe8res instances sur le Cloud de Confiance.","source":"@site/i18n/en/docusaurus-plugin-content-docs/current/iaas/quickstart_iaas.md","sourceDirName":"iaas","slug":"/iaas/quickstart_iaas","permalink":"/en/docs/iaas/quickstart_iaas","draft":false,"unlisted":false,"editUrl":"https://github.com/aelttil/docs-content/docs/iaas/quickstart_iaas.md","tags":[],"version":"current","frontMatter":{"title":"Automatisation avec Terraform"},"sidebar":"docSidebar","previous":{"title":"R\xe9seaux","permalink":"/en/docs/iaas/network"},"next":{"title":"D\xe9ploiement depuis un template","permalink":"/en/docs/iaas/quickstart_iaas_template"}}'),i=r("5893"),s=r("65");let o={title:"Automatisation avec Terraform"},l=void 0,a={},u=[{value:"<strong>Pr\xe9requis</strong>",id:"pr\xe9requis",level:2},{value:"D\xe9ployer une machine virtuelle via Terraform",id:"d\xe9ployer-une-machine-virtuelle-via-terraform",level:2}];function c(e){let n={a:"a",code:"code",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"Ce guide va vous permettre de d\xe9ployer en moins de 5 minutes vos premi\xe8res instances sur le Cloud de Confiance."}),"\n",(0,i.jsx)(n.h2,{id:"pr\xe9requis",children:(0,i.jsx)(n.strong,{children:"Pr\xe9requis"})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Avoir souscrit \xe0 l'offre Cloud Temple (souscription \xe0 l'offre IaaS)."}),"\n",(0,i.jsxs)(n.li,{children:["Avoir les permissions activ\xe9es pour le pilote des objets ",(0,i.jsx)(n.strong,{children:"'IaaS'"})]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"d\xe9ployer-une-machine-virtuelle-via-terraform",children:"D\xe9ployer une machine virtuelle via Terraform"}),"\n",(0,i.jsx)(n.p,{children:"Dans cette section, nous allons voir comment d\xe9ployer en quelques minutes une machine virtuelle sur le Cloud de Confiance via le provider Terraform Cloud Temple.\nSi vous n'avez pas encore utilis\xe9 le provider Cloud Temple, suivez les instructions qui figurent \xe0 l'adresse suivante pour l'installer et vous authentifier \xe0 votre tenant :"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://registry.terraform.io/providers/Cloud-Temple/cloudtemple/latest/docs",children:"https://registry.terraform.io/providers/Cloud-Temple/cloudtemple/latest/docs"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"On va commencer par cr\xe9er un fichier .tf qui d\xe9crit l'instance que l'on souhaite d\xe9ployer.\nLe script suivant permet de d\xe9ployer une machine virtuelle from scratch."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'    data "cloudtemple_compute_virtual_datacenter" "dc" {\n      name = "DC-EQX6"\n    }\n\n    data "cloudtemple_compute_host_cluster" "flo" {\n      name = "clu002-ucs01_FLO"\n    }\n\n    data "cloudtemple_compute_datastore_cluster" "koukou" {\n      name = "sdrs001-LIVE_KOUKOU"\n    }\n\n    resource "cloudtemple_compute_virtual_machine" "scratch" {\n      name = "from-scratch"\n\n      memory                 = 8 * 1024 * 1024 * 1024\n      cpu                    = 2\n      num_cores_per_socket   = 1\n      cpu_hot_add_enabled    = true\n      cpu_hot_remove_enabled = true\n      memory_hot_add_enabled = true\n\n      datacenter_id                = data.cloudtemple_compute_virtual_datacenter.dc.id\n      host_cluster_id              = data.cloudtemple_compute_host_cluster.flo.id\n      datastore_cluster_id         = data.cloudtemple_compute_datastore_cluster.koukou.id\n      guest_operating_system_moref = "amazonlinux2_64Guest"\n \n      tags = {\n        created_by = "Terraform"\n      }\n    }\n'})}),"\n",(0,i.jsx)(n.p,{children:"Les param\xe8tres utilis\xe9s dans ce script sont les suivants :"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"datacenter_id (obligatoire) : datacenter dans lequel la machine virtuelle est d\xe9ploy\xe9e"}),"\n",(0,i.jsx)(n.li,{children:"host_cluster_id (obligatoire) : cluster dans lequel la machine virtuelle est d\xe9ploy\xe9e"}),"\n",(0,i.jsx)(n.li,{children:"name (obligatoire) : nom de la machine"}),"\n",(0,i.jsx)(n.li,{children:"memory : RAM allou\xe9e \xe0 la machine au d\xe9part"}),"\n",(0,i.jsx)(n.li,{children:"cpu : nombre de vCPU allou\xe9s \xe0 la machine au d\xe9part"}),"\n",(0,i.jsx)(n.li,{children:"num_cores_per_socket : nombre de cores par socket"}),"\n",(0,i.jsx)(n.li,{children:"datastore_cluster_id : datastore auquel la machine est rattach\xe9e"}),"\n",(0,i.jsx)(n.li,{children:"guest_operating_system_moref : syst\xe8me d'exploitation de la machine"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"D'autres param\xe8tres peuvent \xeatre appliqu\xe9s \xe0 une machine virtuelle lors de son d\xe9ploiement. Vous pouvez retrouver l'ensemble de ces param\xe8tres \xe0 la page suivante de la documentation Terraform :"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://registry.terraform.io/providers/Cloud-Temple/cloudtemple/latest/docs/resources/compute_virtual_machine",children:"https://registry.terraform.io/providers/Cloud-Temple/cloudtemple/latest/docs/resources/compute_virtual_machine"})}),"\n",(0,i.jsx)(n.p,{children:"Une fois le fichier .tf cr\xe9\xe9 et sauvegard\xe9, ex\xe9cutez la commande suivante pour v\xe9rifier votre code :"}),"\n",(0,i.jsx)(n.p,{children:"terraform validate"}),"\n",(0,i.jsx)(n.p,{children:"Puis, planifiez le d\xe9ploiement et v\xe9rifiez que le plan correspond \xe0 ce que vous souhaitez r\xe9aliser :"}),"\n",(0,i.jsx)(n.p,{children:"terraform plan"}),"\n",(0,i.jsx)(n.p,{children:"Enfin, d\xe9ployez la machine virtuelle en ex\xe9cutant la commande suivante :"}),"\n",(0,i.jsx)(n.p,{children:"terraform apply"}),"\n",(0,i.jsx)(n.p,{children:"##Utiliser cloud-init pour configurer une machine virtuelle d\xe9ploy\xe9e depuis le provider Terraform"}),"\n",(0,i.jsxs)(n.p,{children:["L'outil ",(0,i.jsx)(n.strong,{children:"'cloud-init'"})," permet de personnaliser une machine virtuelle, ou une instance cloud, lors de son premier d\xe9marrage. Il s'agit d'un standard qui est tr\xe8s largement r\xe9pandu.\nPour plus d'informations, se r\xe9f\xe9rer \xe0 la documentation : ",(0,i.jsx)(n.a,{href:"https://cloudinit.readthedocs.io/en/latest/",children:"https://cloudinit.readthedocs.io/en/latest/"})]}),"\n",(0,i.jsx)(n.p,{children:"###Compatibilit\xe9"}),"\n",(0,i.jsxs)(n.p,{children:["Afin d\u2019\xeatre en mesure de configurer via cloud-init une machine virtuelle d\xe9ploy\xe9e depuis le provider Terraform Cloud Temple, l\u2019",(0,i.jsx)(n.strong,{children:"OVF"})," utilis\xe9 pour d\xe9ployer cette derni\xe8re doit \xeatre ",(0,i.jsx)(n.strong,{children:"compatible"})," avec ",(0,i.jsx)(n.strong,{children:"cloud-init"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Pour v\xe9rifier la compatibilit\xe9 de votre machine virtuelle avec cloud-init, entrez la commande suivante :"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"systemctl status cloud-init.service"})}),"\n",(0,i.jsx)(n.p,{children:"Si cloud-init est correctement install\xe9 sur la machine, vous devriez constater une r\xe9ponse comme ceci. (Voir capture d\u2019\xe9cran ci-dessous)"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"img",src:r(2255).Z+"",width:"2162",height:"316"})}),"\n",(0,i.jsxs)(n.p,{children:["Si besoin, vous pouvez trouver des images compatibles cloud-init sur internet (par exemple ",(0,i.jsx)(n.a,{href:"https://cloud-images.ubuntu.com/",children:"Ubuntu Cloud Image"}),") ou l\u2019installer vous-m\xeame sur votre machine avant de la transformer en OVF."]}),"\n",(0,i.jsx)(n.p,{children:"###D\xe9ploiement"}),"\n",(0,i.jsxs)(n.p,{children:["Maintenant que vous \xeates certain que l\u2019OVF d\xe9ploy\xe9 est bien compatible \xe0 cloud-init, voici un exemple de fichier terraform (.tf) que vous pouvez utiliser pour configurer votre machine virtuelle.\nNB : Tous les exemples montr\xe9s ici peuvent \xeatre retrouv\xe9s dans le dossier exemples du repository du provider Terraform Cloud Temple ici : ",(0,i.jsx)(n.a,{href:"https://github.com/Cloud-Temple/terraform-provider-cloudtemple/tree/main/examples",children:"https://github.com/Cloud-Temple/terraform-provider-cloudtemple/tree/main/examples"})]}),"\n",(0,i.jsxs)(n.p,{children:["####",(0,i.jsx)(n.code,{children:"main.tf"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-HCL",children:'resource "cloudtemple_compute_virtual_machine" "ubuntu-cloud-init" {\n  name = "ubuntu-cloud-init"\n\n  memory                 = 8 * 1024 * 1024 * 1024\n  cpu                    = 2\n  num_cores_per_socket   = 1\n  cpu_hot_add_enabled    = true\n  cpu_hot_remove_enabled = true\n  memory_hot_add_enabled = true\n\n  datacenter_id   = data.cloudtemple_compute_virtual_datacenter.TH3S.id\n  host_cluster_id = data.cloudtemple_compute_host_cluster.CLU001.id\n  datastore_id    = data.cloudtemple_compute_datastore.DS003.id\n\n  content_library_id      = data.cloudtemple_compute_content_library.local.id\n  content_library_item_id = data.cloudtemple_compute_content_library_item.ubuntu-cloudimg.id\n\n  power_state = "on"\n\n  backup_sla_policies = [\n    data.cloudtemple_backup_sla_policy.sla001-daily-par7s.id,\n    data.cloudtemple_backup_sla_policy.sla001-weekly-par7s.id,\n  ]\n\n  cloud_init = {\n    network-config = filebase64("./cloud-init/network-config.yml")\n    user-data      = filebase64("./cloud-init/user-data.yml")\n  }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["####",(0,i.jsx)(n.code,{children:"network-config.yml"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-YAML",children:"#cloud-config\nnetwork:\n  version: 2\n  ethernets:\n    eth0:\n      dhcp4: false\n      addresses:\n        - 172.16.100.192/24\n      gateway4: 172.16.100.1\n      nameservers:\n        addresses:\n          - 172.16.11.4\n"})}),"\n",(0,i.jsxs)(n.p,{children:["####",(0,i.jsx)(n.code,{children:"user-data.yml"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-YAML",children:"#cloud-config\nusers:\n  - default\n  - name: terraform\n    primary_group: users\n    shell: /bin/bash\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']\n    groups: sudo\n    lock_passwd: false  \n    plain_text_passwd: password\n"})}),"\n",(0,i.jsxs)(n.p,{children:["L\u2019\xe9lement int\xe9ressant ici, est la pr\xe9sence de la propri\xe9t\xe9 cloud-init, vous pouvez constater qu\u2019elle est compos\xe9 de deux sous-propri\xe9t\xe9s : ",(0,i.jsx)(n.strong,{children:"network-config"}),", et ",(0,i.jsx)(n.strong,{children:"user-data"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Ces derni\xe8res font partie d\u2019un ensemble de 7 propri\xe9t\xe9s que vous pouvez utiliser pour configurer votre machine virtuelle avec cloud-init."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"user-data"}),"\xa0: Cette valeur doit \xeatre encod\xe9e en base64 et contient des notamment des informations de configuration pour les comptes utilisateurs de la machine virtuelle. Vous pouvez aussi y ajouter des scripts permettant d\u2019installer ou mettre \xe0 jour des paquets."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"network-config"}),"\xa0: Cette valeur doit \xeatre encod\xe9e en base64 et contient notamment des informations de configuration r\xe9seau de la machine virtuelle."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"public-keys"})," : Indique que l'instance doit remplir les 'authorized_keys' de l'utilisateur par d\xe9faut avec cette valeur."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"instance-id"})," : Permet de d\xe9finir un identifiant unique d\u2019instance aupr\xe8s de cloud-init."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"password"})," :\xa0S'il est d\xe9fini, le mot de passe de l'utilisateur par d\xe9faut sera d\xe9fini \xe0 cette valeur pour permettre une connexion bas\xe9e sur un mot de passe. Le mot de passe ne sera valable que pour une seule connexion. Si la valeur est 'RANDOM', un mot de passe al\xe9atoire sera g\xe9n\xe9r\xe9 et affich\xe9 sur la console."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"hostname"})," : Sp\xe9cifie un nom d\u2019h\xf4te pour l\u2019instance d\xe9ploy\xe9e."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"seedfrom"})," : Permet de d\xe9finir une URL sur laquelle cloud-init ira chercher les fichiers de configuration qu\u2019il doit utiliser.\nPour plus d'information sur le fonctionnement de cloud-init, veuillez vous r\xe9f\xe9rer \xe0 la documentation officielle. ",(0,i.jsx)(n.a,{href:"https://cloudinit.readthedocs.io/en/latest/",children:"https://cloudinit.readthedocs.io/en/latest/"})]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"###Execution"}),"\n",(0,i.jsx)(n.p,{children:"Pour v\xe9rifier la bonne ex\xe9cution de cloud-init, vous devriez pouvoir vous connecter avec l\u2019utilisateur que vous avez configur\xe9 dans le fichier user-data.yml ou le nom d\u2019h\xf4te changer pour \xeatre d\xe9fini sur celui que vous avez mis dans \u2018hostname\u2019."}),"\n",(0,i.jsx)(n.p,{children:"En cas de soucis, vous pouvez v\xe9rifier les logs de cloud-init en utilisant la commande suivante :"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"sudo cat /var/log/cloud-init-output.log"})}),"\n",(0,i.jsx)(n.p,{children:"Vous devriez voir diverses informations sur l\u2019execution de cloud-init. Sur la capture d\u2019\xe9cran qui suit, on peut constater que la configuration du r\xe9seau s\u2019est correctement pass\xe9e."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:r(8845).Z+"",width:"2028",height:"1480"})})]})}function d(e={}){let{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},8845:function(e,n,r){r.d(n,{Z:function(){return t}});let t=r.p+"assets/images/cloud-init-output-fc245b19698af055d522971ba83f0e6d.png"},2255:function(e,n,r){r.d(n,{Z:function(){return t}});let t=r.p+"assets/images/status_cloud_init-3725fa789e65b4643e836e8b92740a49.png"},65:function(e,n,r){r.d(n,{Z:function(){return l},a:function(){return o}});var t=r(7294);let i={},s=t.createContext(i);function o(e){let n=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);